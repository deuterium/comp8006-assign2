#User Config

#Enter the IP address of the internal address to be used
intAddr=
#Enter the name of the network device to be used internally
intDev=
#Enter the IP address of the external address that is being used
extAddr=
#Enter the name of the network device to be used externally
extDev=
#List TCP ports to allow, comma seperated
tcpPorts=
#List UDP ports to allow, comma seperated
udpPorts=
#List ICP ports to allow, comma seperated
icmpPorts=

#implementation_DO_NOT_TOUCH_BELOW

#disable network manager
systemctl networkmanager.Service disable
#enable forwarding
echo 1 > /proc/sys/net/ipv4/ip_forward

#clear previous rules and chains
iptables -F
iptables --flush
iptables -X

#set default polcies on the firewall to drop all incoming, outgoing and forwarding traffic
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT DROP

#Accepting forwarding between interface devices
iptables -A FORWARD -i $extDev -o $intDev -j ACCEPT
iptables -A FORWARD -i $intDev -o $extDev -j ACCEPT

#Accept user configured ports 
iptables -t nat -A PREROUTING -p tcp -i $extDev -m multiport --dport $tcpPorts[*] -j DNAT --to $intDev
iptables -t nat -A PREROUTING -p udp -i $extDev -m multiport --dport $udpPorts[*] -j DNAT --to $intDev
iptables -t nat -A PREROUTING -p icmp -i $extDev -m multiport --dport $icmpPorts[*] -j DNAT --to $intDev

iptables -t nat -A POSTROUTING -o $extDev -j MASQUERADE

#Accept DNS packets
iptables -A INPUT  -i $extDev-p udp --sport 53 -j ACCEPT
iptables -A OUTPUT -o $extDev -p udp --dport 53 -j ACCEPT

#Accept DHCP packets to port 67:68 for DHCP
iptables -A INPUT  -i $extDev -p udp --dport 67:68 --sport 67:68 -j ACCEPT
iptables -A OUTPUT -o $extDev -p udp --dport 67:68 --sport 67:68 -j ACCEPT


#Drop packets destined for firewall host from outside
iptables -A INPUT -i $extDev -d $extAddr -p tcp --syn -j DROP

#Drop all packets with internal source address from outside matching internal network
iptables -A INPUT -s $intAddr -i $extDev -j DROP

#Drop all inbound SYN on high ports
iptables -A INPUT -i $extDev -p tcp --syn --dport 1024:65535 -j DROP

#Accept fragments
iptables -A INPUT -f -i $extDev -j ACCEPT

#Drop packets with SYN and FIN bits set
iptables -A INPUT -i $extDev -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP
iptables -A OUTPUT -o $extDev -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP

#Drop all telnet packets 
iptables -A INPUT -i $extDev -p tcp --dport 23 -j DROP
iptables -A OUTPUT -o $extDev -p tcp --sport 23 -j DROP

#Accept all TCP packets that belong to existing allowed ports
iptables -A INPUT  -i $extDev -p tcp -m multiport --dport $tcpPorts[*] -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o $extDev -p tcp -m multiport --sport $tcpPorts[*] -m state --state ESTABLISHED -j ACCEPT

#Block all external traffic to ports 32768-32775, 137-139, tcp 111 and 515
iptables -A INPUT -i $extDev -p tcp --dport 32768:32775 -j DROP
iptables -A INPUT -i $extDev -p udp --dport 32768:32775 -j DROP

iptables -A INPUT -i $extDev -p tcp --dport 137:139 -j DROP
iptables -A INPUT -i $extDev -p udp --dport 137:139 -j DROP

iptables -A INPUT -i $extDev -p tcp --dport 111,515 -j DROP

#For FTP and SSH, set Min Delay and Max Throughput (use mangle)
iptables -t mangle -A PREROUTING -m multiport -p tcp --dport 22,ftp,ftp-data -j TOS --set-tos Minimize-Delay
iptables -t mangle -A PREROUTING -m multiport -p tcp --sport 22,ftp,ftp-data -j TOS --set-tos Minimize-Delay
iptables -t mangle -A PREROUTING -m multiport -p tcp --dport 22,ftp,ftp-data -j TOS --set-tos Maximize-Throughput
iptables -t mangle -A PREROUTING -m multiport -p tcp --sport 22,ftp,ftp-data -j TOS --set-tos Maximize-Throughput

iptables -L
